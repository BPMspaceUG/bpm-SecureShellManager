#!/usr/bin/env bash
# SM - SSH Manager
# Quick SSH connection manager with zellij session persistence
# Invoke as 'sml' for list mode

set -uo pipefail

CONFIG_DIR="${HOME}/.config/sm"
CONFIG_FILE="${CONFIG_DIR}/connections.conf"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Initialize config if not exists
init_config() {
    if [[ ! -d "$CONFIG_DIR" ]]; then
        mkdir -p "$CONFIG_DIR"
    fi

    if [[ ! -f "$CONFIG_FILE" ]]; then
        cat > "$CONFIG_FILE" << 'EOF'
# SM - SSH Manager Configuration
# Format: alias|host|port|user|directory|description|[ssh_key]
#
# Example:
# sm231|contabo2.example.com|22|rob-ico|ico-n8n-prozesse2|N8N Server|
# sm232|contabo2.example.com|22|rob-ico|ico-cert|Cert Service|~/.ssh/special_key
#
# Host aliases (optional):
# hostalias:contabo2.example.com=contabo2
#
# Set default connection:
# default=sm231

EOF
        echo -e "${YELLOW}Config file created: $CONFIG_FILE${NC}"
        echo -e "${YELLOW}Please edit it to add your connections.${NC}"
        exit 0
    fi
}

# Get default connection
get_default() {
    grep "^default=" "$CONFIG_FILE" 2>/dev/null | cut -d'=' -f2 | tr -d ' ' || echo ""
}

# Get host alias for a hostname
get_host_alias() {
    local hostname="$1"
    local alias_line=$(grep "^hostalias:${hostname}=" "$CONFIG_FILE" 2>/dev/null || echo "")
    if [[ -n "$alias_line" ]]; then
        echo "${alias_line#*=}"
    else
        echo ""
    fi
}

# List all connections (non-interactive)
list_connections() {
    local default_conn=$(get_default)

    echo -e "${GREEN}=== SM - SSH Manager ===${NC}"
    printf "%-10s %-12s %-15s %-35s\n" "ALIAS" "HOSTALIAS" "USER" "DIRECTORY"
    echo "--------------------------------------------------------------------------------"

    while IFS='|' read -r alias host port user directory description key; do
        # Skip comments, empty lines, host aliases, default
        [[ "$alias" =~ ^#.*$ ]] && continue
        [[ -z "$alias" ]] && continue
        [[ "$alias" =~ ^default= ]] && continue
        [[ "$alias" =~ ^hostalias: ]] && continue

        local hostalias=$(get_host_alias "$host")

        # Highlight default (green row)
        if [[ "$alias" == "$default_conn" ]]; then
            printf "${GREEN}%-10s %-12s %-15s %-35s${NC}\n" "$alias" "$hostalias" "$user" "$directory"
        else
            printf "%-10s %-12s %-15s %-35s\n" "$alias" "$hostalias" "$user" "$directory"
        fi
    done < "$CONFIG_FILE"
}

# Interactive selection with arrow keys
interactive_select() {
    local default_conn=$(get_default)
    local aliases=()
    local hostaliases=()
    local users=()
    local directories=()

    # Build arrays
    while IFS='|' read -r alias host port user directory description key; do
        [[ "$alias" =~ ^#.*$ ]] && continue
        [[ -z "$alias" ]] && continue
        [[ "$alias" =~ ^default= ]] && continue
        [[ "$alias" =~ ^hostalias: ]] && continue

        aliases+=("$alias")
        hostaliases+=("$(get_host_alias "$host")")
        users+=("$user")
        directories+=("$directory")
    done < "$CONFIG_FILE"

    local count=${#aliases[@]}
    if [[ $count -eq 0 ]]; then
        echo -e "${RED}No connections configured${NC}"
        exit 1
    fi

    # Find initial selection (default or first)
    local selected=0
    for i in "${!aliases[@]}"; do
        if [[ "${aliases[$i]}" == "$default_conn" ]]; then
            selected=$i
            break
        fi
    done

    # Hide cursor
    tput civis
    trap 'tput cnorm' EXIT

    # Draw function
    draw_menu() {
        # Move to top and clear
        tput cup 0 0
        tput ed

        echo -e "${GREEN}=== SM - SSH Manager ===${NC}"
        printf "%-10s %-12s %-15s %-35s\n" "ALIAS" "HOSTALIAS" "USER" "DIRECTORY"
        echo "--------------------------------------------------------------------------------"

        for i in "${!aliases[@]}"; do
            local is_default=false
            [[ "${aliases[$i]}" == "$default_conn" ]] && is_default=true

            if [[ $i -eq $selected ]]; then
                # Selected row - inverse video
                if [[ "$is_default" == "true" ]]; then
                    printf "${GREEN}\e[7m> %-8s %-12s %-15s %-35s\e[27m${NC}\n" "${aliases[$i]}" "${hostaliases[$i]}" "${users[$i]}" "${directories[$i]}"
                else
                    printf "\e[7m> %-8s %-12s %-15s %-35s\e[27m\n" "${aliases[$i]}" "${hostaliases[$i]}" "${users[$i]}" "${directories[$i]}"
                fi
            else
                if [[ "$is_default" == "true" ]]; then
                    printf "${GREEN}  %-8s %-12s %-15s %-35s${NC}\n" "${aliases[$i]}" "${hostaliases[$i]}" "${users[$i]}" "${directories[$i]}"
                else
                    printf "  %-8s %-12s %-15s %-35s\n" "${aliases[$i]}" "${hostaliases[$i]}" "${users[$i]}" "${directories[$i]}"
                fi
            fi
        done

        echo ""
        echo -e "${YELLOW}↑↓ Navigate | Enter: Connect | c: Claude | r: Claude -r | D: Default | Esc/Q: Exit${NC}"
    }

    # Draw menu
    tput cup 0 0
    tput ed
    draw_menu

    # Read keys
    while true; do
        # Read single key
        IFS= read -rsn1 key || continue

        if [[ "$key" == $'\x1b' ]]; then
            # Escape sequence - read more
            read -rsn2 -t 0.1 seq || true
            if [[ "$seq" == '[A' ]]; then
                # Up arrow - wrap to bottom
                if [[ $selected -gt 0 ]]; then
                    selected=$((selected - 1))
                else
                    selected=$((count - 1))
                fi
                draw_menu
            elif [[ "$seq" == '[B' ]]; then
                # Down arrow - wrap to top
                if [[ $selected -lt $((count - 1)) ]]; then
                    selected=$((selected + 1))
                else
                    selected=0
                fi
                draw_menu
            elif [[ -z "$seq" ]]; then
                # Just Escape
                tput cnorm
                exit 0
            fi
        elif [[ "$key" == '' ]]; then
            # Enter key - connect with zellij session restore
            tput cnorm
            connect "${aliases[$selected]}"
        elif [[ "$key" == 'c' || "$key" == 'C' ]]; then
            # c key - connect and start claude
            tput cnorm
            connect "${aliases[$selected]}" "claude"
        elif [[ "$key" == 'r' || "$key" == 'R' ]]; then
            # r key - connect and start claude -r
            tput cnorm
            connect "${aliases[$selected]}" "claude -r"
        elif [[ "$key" == 'd' || "$key" == 'D' ]]; then
            # D key - set default
            set_default "${aliases[$selected]}"
            default_conn="${aliases[$selected]}"
            draw_menu
        elif [[ "$key" == 'q' || "$key" == 'Q' ]]; then
            # Q to quit
            tput cnorm
            exit 0
        fi
    done
}

# Set default connection
set_default() {
    local new_default="$1"

    # Check if connection exists
    if ! grep -q "^${new_default}|" "$CONFIG_FILE"; then
        echo -e "${RED}Error: Connection '$new_default' not found${NC}"
        exit 1
    fi

    # Remove old default
    sed -i '/^default=/d' "$CONFIG_FILE"

    # Add new default
    echo "default=$new_default" >> "$CONFIG_FILE"

    echo -e "${GREEN}Default set to: $new_default${NC}"
}

# Connect to a connection
connect() {
    local alias="$1"
    local start_command="${2:-}"

    # Parse connection
    local line=$(grep "^${alias}|" "$CONFIG_FILE" 2>/dev/null || echo "")

    if [[ -z "$line" ]]; then
        echo -e "${RED}Error: Connection '$alias' not found${NC}"
        exit 1
    fi

    IFS='|' read -r _ host port user directory description key <<< "$line"

    # Build SSH command
    local ssh_cmd="ssh"

    if [[ -n "$key" ]]; then
        ssh_cmd="$ssh_cmd -i $key"
    fi

    ssh_cmd="$ssh_cmd -p $port ${user}@${host}"

    # Build remote command - use zellij for session persistence
    local session_name="${alias}"
    local cd_cmd=""
    [[ -n "$directory" ]] && cd_cmd="cd $directory 2>/dev/null; "

    local remote_cmd=""

    if [[ -n "$start_command" ]]; then
        # c or r pressed: Create 2-pane layout (command top, bash bottom)
        # If session exists, attach to it. Otherwise create with layout.
        local cmd_name="${start_command%% *}"
        local cmd_args=""
        if [[ "$start_command" == *" "* ]]; then
            cmd_args="${start_command#* }"
        fi

        # Build layout file content
        local layout_content=""
        if [[ -n "$cmd_args" ]]; then
            layout_content='layout { pane split_direction="vertical" { pane command="'"${cmd_name}"'" { args "'"${cmd_args}"'" } ; pane focus=true } }'
        else
            layout_content='layout { pane split_direction="vertical" { pane command="'"${cmd_name}"'" ; pane focus=true } }'
        fi

        # Create layout file first, then try attach or create new
        remote_cmd="${cd_cmd}mkdir -p /tmp/sm-layouts; printf '%s\n' '${layout_content}' > /tmp/sm-layouts/${session_name}.kdl; zellij attach ${session_name} || zellij --session ${session_name} --layout /tmp/sm-layouts/${session_name}.kdl"
    else
        # Enter pressed: Simple session, attach or create
        remote_cmd="${cd_cmd}zellij attach ${session_name} -c"
    fi

    echo -e "${GREEN}Connecting to: $alias ($description)${NC}"
    echo -e "${BLUE}Host: ${user}@${host}:${port}${NC}"

    if [[ -n "$directory" ]]; then
        echo -e "${BLUE}Directory: $directory${NC}"
    fi

    if [[ -n "$start_command" ]]; then
        echo -e "${YELLOW}Starting: $start_command (top pane)${NC}"
    fi

    echo -e "${BLUE}Session: zellij ${session_name}${NC}"
    echo ""

    # Execute
    exec $ssh_cmd -t "$remote_cmd"
}

# Main
main() {
    init_config

    # Get script name (for smd, sml detection)
    local script_name=$(basename "$0")

    # Handle different invocations
    case "$script_name" in
        smd)
            # smd = connect to default (quick access)
            local default_conn=$(get_default)
            if [[ -n "$default_conn" ]]; then
                connect "$default_conn"
            else
                echo -e "${RED}No default connection set. Use 'sm set <alias>' to set one.${NC}"
                exit 1
            fi
            ;;
        sml)
            # sml = list connections
            list_connections
            ;;
        sm)
            # sm with arguments
            if [[ $# -eq 0 ]]; then
                # No args = interactive selection
                interactive_select
            elif [[ "$1" == "list" ]]; then
                list_connections
            elif [[ "$1" == "set" ]]; then
                if [[ $# -lt 2 ]]; then
                    echo -e "${RED}Usage: sm set <alias>${NC}"
                    exit 1
                fi
                set_default "$2"
            else
                # Direct connection by alias
                connect "$1"
            fi
            ;;
        *)
            echo -e "${RED}Unknown command: $script_name${NC}"
            exit 1
            ;;
    esac
}

main "$@"
