#!/usr/bin/env bash
# SM - SSH Manager
# Quick SSH connection manager with zellij session persistence
# Invoke as 'sml' for list mode

set -uo pipefail

CONFIG_DIR="${HOME}/.config/sm"
CONFIG_FILE="${CONFIG_DIR}/connections.conf"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Initialize config if not exists
init_config() {
    if [[ ! -d "$CONFIG_DIR" ]]; then
        mkdir -p "$CONFIG_DIR"
    fi

    if [[ ! -f "$CONFIG_FILE" ]]; then
        cat > "$CONFIG_FILE" << 'EOF'
# SM - SSH Manager Configuration
# Format: alias|host|port|user|directory|description|[ssh_key]
#
# Example:
# sm231|contabo2.example.com|22|rob-ico|ico-n8n-prozesse2|N8N Server|
# sm232|contabo2.example.com|22|rob-ico|ico-cert|Cert Service|~/.ssh/special_key
#
# Host aliases (optional):
# hostalias:contabo2.example.com=contabo2
#
# Set default connection:
# default=sm231

EOF
        echo -e "${YELLOW}Config file created: $CONFIG_FILE${NC}"
        echo -e "${YELLOW}Please edit it to add your connections.${NC}"
        exit 0
    fi
}

# Get default connection
get_default() {
    grep "^default=" "$CONFIG_FILE" 2>/dev/null | cut -d'=' -f2 | tr -d ' ' || echo ""
}

# Get host alias for a hostname
get_host_alias() {
    local hostname="$1"
    local alias_line=$(grep "^hostalias:${hostname}=" "$CONFIG_FILE" 2>/dev/null || echo "")
    if [[ -n "$alias_line" ]]; then
        echo "${alias_line#*=}"
    else
        echo ""
    fi
}

# List all connections (non-interactive)
list_connections() {
    local default_conn=$(get_default)

    echo -e "${GREEN}=== SM - SSH Manager ===${NC}"
    printf "%-10s %-12s %-15s %-35s\n" "ALIAS" "HOSTALIAS" "USER" "DIRECTORY"
    echo "--------------------------------------------------------------------------------"

    while IFS='|' read -r alias host port user directory description key; do
        # Skip comments, empty lines, host aliases, default
        [[ "$alias" =~ ^#.*$ ]] && continue
        [[ -z "$alias" ]] && continue
        [[ "$alias" =~ ^default= ]] && continue
        [[ "$alias" =~ ^hostalias: ]] && continue

        local hostalias=$(get_host_alias "$host")

        # Highlight default (green row)
        if [[ "$alias" == "$default_conn" ]]; then
            printf "${GREEN}%-10s %-12s %-15s %-35s${NC}\n" "$alias" "$hostalias" "$user" "$directory"
        else
            printf "%-10s %-12s %-15s %-35s\n" "$alias" "$hostalias" "$user" "$directory"
        fi
    done < "$CONFIG_FILE"
}

# Interactive selection with arrow keys
interactive_select() {
    local default_conn=$(get_default)
    local aliases=()
    local hostaliases=()
    local users=()
    local directories=()

    # Build arrays
    while IFS='|' read -r alias host port user directory description key; do
        [[ "$alias" =~ ^#.*$ ]] && continue
        [[ -z "$alias" ]] && continue
        [[ "$alias" =~ ^default= ]] && continue
        [[ "$alias" =~ ^hostalias: ]] && continue

        aliases+=("$alias")
        hostaliases+=("$(get_host_alias "$host")")
        users+=("$user")
        directories+=("$directory")
    done < "$CONFIG_FILE"

    local count=${#aliases[@]}
    if [[ $count -eq 0 ]]; then
        echo -e "${RED}No connections configured${NC}"
        exit 1
    fi

    # Find initial selection (default or first)
    local selected=0
    for i in "${!aliases[@]}"; do
        if [[ "${aliases[$i]}" == "$default_conn" ]]; then
            selected=$i
            break
        fi
    done

    # Hide cursor and setup cleanup
    cleanup() {
        tput cnorm 2>/dev/null
        printf '\e[?1000l\e[?1002l\e[?1003l\e[?1006l' 2>/dev/null
    }
    tput civis
    trap cleanup EXIT INT TERM HUP

    # Draw function
    draw_menu() {
        # Move to top and clear
        tput cup 0 0
        tput ed

        echo -e "${GREEN}=== SM - SSH Manager ===${NC}"
        printf "%-10s %-12s %-15s %-35s\n" "ALIAS" "HOSTALIAS" "USER" "DIRECTORY"
        echo "--------------------------------------------------------------------------------"

        for i in "${!aliases[@]}"; do
            local is_default=false
            [[ "${aliases[$i]}" == "$default_conn" ]] && is_default=true

            if [[ $i -eq $selected ]]; then
                # Selected row - inverse video
                if [[ "$is_default" == "true" ]]; then
                    printf "${GREEN}\e[7m> %-8s %-12s %-15s %-35s\e[27m${NC}\n" "${aliases[$i]}" "${hostaliases[$i]}" "${users[$i]}" "${directories[$i]}"
                else
                    printf "\e[7m> %-8s %-12s %-15s %-35s\e[27m\n" "${aliases[$i]}" "${hostaliases[$i]}" "${users[$i]}" "${directories[$i]}"
                fi
            else
                if [[ "$is_default" == "true" ]]; then
                    printf "${GREEN}  %-8s %-12s %-15s %-35s${NC}\n" "${aliases[$i]}" "${hostaliases[$i]}" "${users[$i]}" "${directories[$i]}"
                else
                    printf "  %-8s %-12s %-15s %-35s\n" "${aliases[$i]}" "${hostaliases[$i]}" "${users[$i]}" "${directories[$i]}"
                fi
            fi
        done

        echo ""
        echo -e "${YELLOW}↑↓ Navigate | Enter: Connect | L: List Sessions | R: Reset | D: Default | Esc/Q: Exit${NC}"
    }

    # Draw menu
    tput cup 0 0
    tput ed
    draw_menu

    # Read keys
    while true; do
        # Read single key
        IFS= read -rsn1 key || continue

        if [[ "$key" == $'\x1b' ]]; then
            # Escape sequence - read more
            read -rsn2 -t 0.1 seq || true
            if [[ "$seq" == '[A' ]]; then
                # Up arrow - wrap to bottom
                if [[ $selected -gt 0 ]]; then
                    selected=$((selected - 1))
                else
                    selected=$((count - 1))
                fi
                draw_menu
            elif [[ "$seq" == '[B' ]]; then
                # Down arrow - wrap to top
                if [[ $selected -lt $((count - 1)) ]]; then
                    selected=$((selected + 1))
                else
                    selected=0
                fi
                draw_menu
            elif [[ -z "$seq" ]]; then
                # Just Escape
                tput cnorm
                exit 0
            fi
        elif [[ "$key" == '' ]]; then
            # Enter key - connect with zellij session restore
            tput cnorm
            connect "${aliases[$selected]}"
        elif [[ "$key" == 'r' || "$key" == 'R' ]]; then
            # R key - reset session (delete and create fresh)
            tput cnorm
            connect_reset "${aliases[$selected]}"
        elif [[ "$key" == 'l' || "$key" == 'L' ]]; then
            # L key - list sessions on server and connect
            tput cnorm
            list_and_connect "${aliases[$selected]}"
        elif [[ "$key" == 'd' || "$key" == 'D' ]]; then
            # D key - set default
            set_default "${aliases[$selected]}"
            default_conn="${aliases[$selected]}"
            draw_menu
        elif [[ "$key" == 'q' || "$key" == 'Q' ]]; then
            # Q to quit
            tput cnorm
            exit 0
        fi
    done
}

# Set default connection
set_default() {
    local new_default="$1"

    # Check if connection exists
    if ! grep -q "^${new_default}|" "$CONFIG_FILE"; then
        echo -e "${RED}Error: Connection '$new_default' not found${NC}"
        exit 1
    fi

    # Remove old default
    sed -i '/^default=/d' "$CONFIG_FILE"

    # Add new default
    echo "default=$new_default" >> "$CONFIG_FILE"

    echo -e "${GREEN}Default set to: $new_default${NC}"
}

# List sessions on server and connect to selected one
list_and_connect() {
    local alias="$1"

    # Parse connection
    local line=$(grep "^${alias}|" "$CONFIG_FILE" 2>/dev/null || echo "")

    if [[ -z "$line" ]]; then
        echo -e "${RED}Error: Connection '$alias' not found${NC}"
        exit 1
    fi

    IFS='|' read -r _ host port user directory description key <<< "$line"

    # Build SSH command
    local ssh_cmd="ssh"
    if [[ -n "$key" ]]; then
        ssh_cmd="$ssh_cmd -i $key"
    fi
    ssh_cmd="$ssh_cmd -p $port ${user}@${host}"

    local cd_cmd=""
    [[ -n "$directory" ]] && cd_cmd="cd $directory 2>/dev/null; "

    echo -e "${GREEN}=== Sessions on $alias ($description) ===${NC}"
    echo -e "${YELLOW}Fetching sessions...${NC}"

    # Get sessions from server (strip ANSI color codes)
    local sessions=$($ssh_cmd "zellij list-sessions 2>/dev/null" | sed 's/\x1b\[[0-9;]*m//g' | grep -v "^$")

    if [[ -z "$sessions" ]]; then
        echo -e "${RED}No sessions found on server.${NC}"
        read -p "Create new session '$alias'? [Y/n/b=back] " confirm
        if [[ "$confirm" == "n" || "$confirm" == "N" ]]; then
            exit 0
        elif [[ "$confirm" == "b" || "$confirm" == "B" ]]; then
            exec "$0"
        fi
        exec $ssh_cmd -t "${cd_cmd}zellij attach -c ${alias}"
    fi

    # Build session array
    local session_array=()
    while IFS= read -r session; do
        session_array+=("$session")
    done <<< "$sessions"

    # Add "New session" option
    session_array+=("[NEW] Create session '$alias'")

    local count=${#session_array[@]}
    local selected=0

    # Hide cursor
    tput civis
    trap 'tput cnorm' EXIT

    # Draw function
    draw_sessions() {
        tput cup 0 0
        tput ed

        echo -e "${GREEN}=== Sessions on $alias ($description) ===${NC}"
        echo ""

        for i in "${!session_array[@]}"; do
            local session="${session_array[$i]}"
            local is_new=false
            local is_exited=false
            [[ "$session" == "[NEW]"* ]] && is_new=true
            [[ "$session" == *"(EXITED)"* ]] && is_exited=true

            if [[ $i -eq $selected ]]; then
                if [[ "$is_new" == "true" ]]; then
                    printf "${BLUE}\e[7m> %s\e[27m${NC}\n" "$session"
                elif [[ "$is_exited" == "true" ]]; then
                    printf "${RED}\e[7m> %s\e[27m${NC}\n" "$session"
                else
                    printf "${GREEN}\e[7m> %s\e[27m${NC}\n" "$session"
                fi
            else
                if [[ "$is_new" == "true" ]]; then
                    printf "${BLUE}  %s${NC}\n" "$session"
                elif [[ "$is_exited" == "true" ]]; then
                    printf "${RED}  %s${NC}\n" "$session"
                else
                    printf "${GREEN}  %s${NC}\n" "$session"
                fi
            fi
        done

        echo ""
        echo -e "${YELLOW}↑↓ Navigate | Enter: Connect | Esc/Q: Cancel${NC}"
    }

    tput cup 0 0
    tput ed
    draw_sessions

    # Read keys
    while true; do
        IFS= read -rsn1 key || continue

        if [[ "$key" == $'\x1b' ]]; then
            read -rsn2 -t 0.1 seq || true
            if [[ "$seq" == '[A' ]]; then
                # Up arrow
                if [[ $selected -gt 0 ]]; then
                    selected=$((selected - 1))
                else
                    selected=$((count - 1))
                fi
                draw_sessions
            elif [[ "$seq" == '[B' ]]; then
                # Down arrow
                if [[ $selected -lt $((count - 1)) ]]; then
                    selected=$((selected + 1))
                else
                    selected=0
                fi
                draw_sessions
            elif [[ -z "$seq" ]]; then
                # Escape - back to main menu
                tput cnorm
                exec "$0"
            fi
        elif [[ "$key" == '' ]]; then
            # Enter - connect
            tput cnorm
            local selected_session="${session_array[$selected]}"

            if [[ "$selected_session" == "[NEW]"* ]]; then
                echo -e "${GREEN}Creating/attaching session '$alias'...${NC}"
                exec $ssh_cmd -t "${cd_cmd}zellij attach -c ${alias}"
            else
                local session_name=$(echo "$selected_session" | awk '{print $1}')
                echo -e "${GREEN}Connecting to session '$session_name'...${NC}"
                exec $ssh_cmd -t "${cd_cmd}zellij attach ${session_name}"
            fi
        elif [[ "$key" == 'q' || "$key" == 'Q' ]]; then
            # Q - back to main menu
            tput cnorm
            exec "$0"
        fi
    done
}

# Reset and connect (delete old session, create fresh)
connect_reset() {
    local alias="$1"

    # Parse connection
    local line=$(grep "^${alias}|" "$CONFIG_FILE" 2>/dev/null || echo "")

    if [[ -z "$line" ]]; then
        echo -e "${RED}Error: Connection '$alias' not found${NC}"
        exit 1
    fi

    IFS='|' read -r _ host port user directory description key <<< "$line"

    # Build SSH command
    local ssh_cmd="ssh"
    if [[ -n "$key" ]]; then
        ssh_cmd="$ssh_cmd -i $key"
    fi
    ssh_cmd="$ssh_cmd -p $port ${user}@${host}"

    local session_name="${alias}"
    local cd_cmd=""
    [[ -n "$directory" ]] && cd_cmd="cd $directory 2>/dev/null; "

    echo -e "${GREEN}Resetting: $alias ($description)${NC}"
    echo -e "${YELLOW}Checking for existing session...${NC}"

    # Check if session exists (strip ANSI codes for matching)
    if $ssh_cmd "zellij list-sessions 2>/dev/null | sed 's/\x1b\[[0-9;]*m//g' | grep -q '${session_name}'"; then
        echo -e "${RED}Session '${session_name}' exists!${NC}"
        read -p "Delete and create fresh? [y/N] " confirm
        if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
            echo "Cancelled."
            exit 0
        fi
        echo -e "${YELLOW}Deleting and recreating session...${NC}"
    else
        echo -e "${GREEN}No existing session, creating new...${NC}"
    fi
    echo ""

    # Delete session with force (ignore errors) and create fresh
    local remote_cmd="zellij delete-session ${session_name} --force 2>/dev/null; ${cd_cmd}zellij attach -c ${session_name}"
    exec $ssh_cmd -t "$remote_cmd"
}

# Connect to a connection
connect() {
    local alias="$1"

    # Parse connection
    local line=$(grep "^${alias}|" "$CONFIG_FILE" 2>/dev/null || echo "")

    if [[ -z "$line" ]]; then
        echo -e "${RED}Error: Connection '$alias' not found${NC}"
        exit 1
    fi

    IFS='|' read -r _ host port user directory description key <<< "$line"

    # Build SSH command
    local ssh_cmd="ssh"

    if [[ -n "$key" ]]; then
        ssh_cmd="$ssh_cmd -i $key"
    fi

    ssh_cmd="$ssh_cmd -p $port ${user}@${host}"

    # Build remote command - use zellij for session persistence
    local session_name="${alias}"
    local cd_cmd=""
    [[ -n "$directory" ]] && cd_cmd="cd $directory 2>/dev/null; "

    # Attach or create session (try attach first, create if not exists)
    local remote_cmd="${cd_cmd}zellij attach -c ${session_name}"

    echo -e "${GREEN}Connecting to: $alias ($description)${NC}"
    echo -e "${BLUE}Host: ${user}@${host}:${port}${NC}"

    if [[ -n "$directory" ]]; then
        echo -e "${BLUE}Directory: $directory${NC}"
    fi

    echo -e "${BLUE}Session: zellij ${session_name}${NC}"
    echo ""

    # Execute
    exec $ssh_cmd -t "$remote_cmd"
}

# Main
main() {
    init_config

    # Get script name (for smd, sml detection)
    local script_name=$(basename "$0")

    # Handle different invocations
    case "$script_name" in
        smd)
            # smd = connect to default (quick access)
            local default_conn=$(get_default)
            if [[ -n "$default_conn" ]]; then
                connect "$default_conn"
            else
                echo -e "${RED}No default connection set. Use 'sm set <alias>' to set one.${NC}"
                exit 1
            fi
            ;;
        sml)
            # sml = list zellij sessions on default server
            local default_conn=$(get_default)
            if [[ -n "$default_conn" ]]; then
                list_and_connect "$default_conn"
            else
                echo -e "${RED}No default connection set. Use 'sm set <alias>' to set one.${NC}"
                exit 1
            fi
            ;;
        sm)
            # sm with arguments
            if [[ $# -eq 0 ]]; then
                # No args = interactive selection
                interactive_select
            elif [[ "$1" == "list" ]]; then
                list_connections
            elif [[ "$1" == "set" ]]; then
                if [[ $# -lt 2 ]]; then
                    echo -e "${RED}Usage: sm set <alias>${NC}"
                    exit 1
                fi
                set_default "$2"
            else
                # Direct connection by alias
                connect "$1"
            fi
            ;;
        *)
            echo -e "${RED}Unknown command: $script_name${NC}"
            exit 1
            ;;
    esac
}

main "$@"
