#!/usr/bin/env bash
# SM - SSH Manager
# Quick SSH connection manager with directory + command execution

set -uo pipefail

CONFIG_DIR="${HOME}/.config/sm"
CONFIG_FILE="${CONFIG_DIR}/connections.conf"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Initialize config if not exists
init_config() {
    if [[ ! -d "$CONFIG_DIR" ]]; then
        mkdir -p "$CONFIG_DIR"
    fi

    if [[ ! -f "$CONFIG_FILE" ]]; then
        cat > "$CONFIG_FILE" << 'EOF'
# SM - SSH Manager Configuration
# Format: alias|host|port|user|directory|command|description|[ssh_key]
#
# Example:
# sm231|contabo2.example.com|22|rob-ico|ico-n8n-prozesse2|claude --resume|N8N Claude|
# sm232|contabo2.example.com|22|rob-ico|ico-cert|npm start|Cert Service|~/.ssh/special_key
#
# Set default connection:
# default=sm231

EOF
        echo -e "${YELLOW}Config file created: $CONFIG_FILE${NC}"
        echo -e "${YELLOW}Please edit it to add your connections.${NC}"
        exit 0
    fi
}

# Get default connection
get_default() {
    grep "^default=" "$CONFIG_FILE" 2>/dev/null | cut -d'=' -f2 | tr -d ' ' || echo ""
}

# Get host alias for a hostname
get_host_alias() {
    local hostname="$1"
    local alias_line=$(grep "^hostalias:${hostname}=" "$CONFIG_FILE" 2>/dev/null || echo "")
    if [[ -n "$alias_line" ]]; then
        echo "${alias_line#*=}"
    else
        echo ""
    fi
}

# List all connections (non-interactive)
list_connections() {
    local default_conn=$(get_default)

    echo -e "${GREEN}=== SM - SSH Manager ===${NC}"
    printf "%-10s %-12s %-15s %-35s %s\n" "ALIAS" "HOSTALIAS" "USER" "DIRECTORY" "COMMAND"
    echo "--------------------------------------------------------------------------------"

    while IFS='|' read -r alias host port user directory command description key; do
        # Skip comments, empty lines, host aliases, default
        [[ "$alias" =~ ^#.*$ ]] && continue
        [[ -z "$alias" ]] && continue
        [[ "$alias" =~ ^default= ]] && continue
        [[ "$alias" =~ ^hostalias: ]] && continue

        local hostalias=$(get_host_alias "$host")

        # Highlight default (green row)
        if [[ "$alias" == "$default_conn" ]]; then
            printf "${GREEN}%-10s %-12s %-15s %-35s %s${NC}\n" "$alias" "$hostalias" "$user" "$directory" "$command"
        else
            printf "%-10s %-12s %-15s %-35s %s\n" "$alias" "$hostalias" "$user" "$directory" "$command"
        fi
    done < "$CONFIG_FILE"
}

# Interactive selection with arrow keys
interactive_select() {
    local default_conn=$(get_default)
    local aliases=()
    local hostaliases=()
    local users=()
    local directories=()
    local commands=()

    # Build arrays
    while IFS='|' read -r alias host port user directory command description key; do
        [[ "$alias" =~ ^#.*$ ]] && continue
        [[ -z "$alias" ]] && continue
        [[ "$alias" =~ ^default= ]] && continue
        [[ "$alias" =~ ^hostalias: ]] && continue

        aliases+=("$alias")
        hostaliases+=("$(get_host_alias "$host")")
        users+=("$user")
        directories+=("$directory")
        commands+=("$command")
    done < "$CONFIG_FILE"

    local count=${#aliases[@]}
    if [[ $count -eq 0 ]]; then
        echo -e "${RED}No connections configured${NC}"
        exit 1
    fi

    # Find initial selection (default or first)
    local selected=0
    for i in "${!aliases[@]}"; do
        if [[ "${aliases[$i]}" == "$default_conn" ]]; then
            selected=$i
            break
        fi
    done

    # Hide cursor
    tput civis
    trap 'tput cnorm' EXIT

    # Draw function
    draw_menu() {
        # Move to top and clear
        tput cup 0 0
        tput ed

        echo -e "${GREEN}=== SM - SSH Manager ===${NC}"
        printf "%-10s %-12s %-15s %-35s %s\n" "ALIAS" "HOSTALIAS" "USER" "DIRECTORY" "COMMAND"
        echo "--------------------------------------------------------------------------------"

        for i in "${!aliases[@]}"; do
            local is_default=false
            [[ "${aliases[$i]}" == "$default_conn" ]] && is_default=true

            if [[ $i -eq $selected ]]; then
                # Selected row - inverse video
                if [[ "$is_default" == "true" ]]; then
                    printf "${GREEN}\e[7m> %-8s %-12s %-15s %-35s %s\e[27m${NC}\n" "${aliases[$i]}" "${hostaliases[$i]}" "${users[$i]}" "${directories[$i]}" "${commands[$i]}"
                else
                    printf "\e[7m> %-8s %-12s %-15s %-35s %s\e[27m\n" "${aliases[$i]}" "${hostaliases[$i]}" "${users[$i]}" "${directories[$i]}" "${commands[$i]}"
                fi
            else
                if [[ "$is_default" == "true" ]]; then
                    printf "${GREEN}  %-8s %-12s %-15s %-35s %s${NC}\n" "${aliases[$i]}" "${hostaliases[$i]}" "${users[$i]}" "${directories[$i]}" "${commands[$i]}"
                else
                    printf "  %-8s %-12s %-15s %-35s %s\n" "${aliases[$i]}" "${hostaliases[$i]}" "${users[$i]}" "${directories[$i]}" "${commands[$i]}"
                fi
            fi
        done

        echo ""
        echo -e "${YELLOW}↑↓ Navigate | Enter: Connect | T: Tmux Split | D: Set Default | Esc/Q: Exit${NC}"
    }

    # Clear screen and draw
    clear
    draw_menu

    # Read keys
    while true; do
        # Read single key
        IFS= read -rsn1 key || continue

        if [[ "$key" == $'\x1b' ]]; then
            # Escape sequence - read more
            read -rsn2 -t 0.1 seq || true
            if [[ "$seq" == '[A' ]]; then
                # Up arrow - wrap to bottom
                if [[ $selected -gt 0 ]]; then
                    selected=$((selected - 1))
                else
                    selected=$((count - 1))
                fi
                draw_menu
            elif [[ "$seq" == '[B' ]]; then
                # Down arrow - wrap to top
                if [[ $selected -lt $((count - 1)) ]]; then
                    selected=$((selected + 1))
                else
                    selected=0
                fi
                draw_menu
            elif [[ -z "$seq" ]]; then
                # Just Escape
                tput cnorm
                clear
                exit 0
            fi
        elif [[ "$key" == '' ]]; then
            # Enter key - connect
            tput cnorm
            clear
            connect "${aliases[$selected]}"
        elif [[ "$key" == 't' || "$key" == 'T' ]]; then
            # T key - connect with tmux split
            tput cnorm
            clear
            connect "${aliases[$selected]}" "true"
        elif [[ "$key" == 'd' || "$key" == 'D' ]]; then
            # D key - set default
            set_default "${aliases[$selected]}"
            default_conn="${aliases[$selected]}"
            draw_menu
        elif [[ "$key" == 'q' || "$key" == 'Q' ]]; then
            # Q to quit
            tput cnorm
            clear
            exit 0
        fi
    done
}

# Set default connection
set_default() {
    local new_default="$1"

    # Check if connection exists
    if ! grep -q "^${new_default}|" "$CONFIG_FILE"; then
        echo -e "${RED}Error: Connection '$new_default' not found${NC}"
        exit 1
    fi

    # Remove old default
    sed -i '/^default=/d' "$CONFIG_FILE"

    # Add new default
    echo "default=$new_default" >> "$CONFIG_FILE"

    echo -e "${GREEN}Default set to: $new_default${NC}"
}

# Interactive default selection
select_default_interactive() {
    local current_default=$(get_default)
    local aliases=()
    local descriptions=()
    local i=1

    echo -e "${BLUE}=== Select Default Connection ===${NC}"
    echo ""

    # Build list of connections
    while IFS='|' read -r alias host port user directory command description key; do
        [[ "$alias" =~ ^#.*$ ]] && continue
        [[ -z "$alias" ]] && continue
        [[ "$alias" =~ ^default= ]] && continue

        aliases+=("$alias")
        descriptions+=("$description")

        if [[ "$alias" == "$current_default" ]]; then
            printf "${GREEN}%2d) %-10s - %s (current)${NC}\n" "$i" "$alias" "$description"
        else
            printf "%2d) %-10s - %s\n" "$i" "$alias" "$description"
        fi
        ((i++))
    done < "$CONFIG_FILE"

    echo ""
    printf " 0) Cancel\n"
    echo ""

    read -p "Select [0-$((i-1))]: " selection

    if [[ "$selection" == "0" ]] || [[ -z "$selection" ]]; then
        echo "Cancelled."
        exit 0
    fi

    if [[ "$selection" =~ ^[0-9]+$ ]] && (( selection >= 1 && selection < i )); then
        set_default "${aliases[$((selection-1))]}"
    else
        echo -e "${RED}Invalid selection${NC}"
        exit 1
    fi
}

# Connect to a connection
connect() {
    local alias="$1"
    local use_tmux="${2:-false}"

    # Parse connection
    local line=$(grep "^${alias}|" "$CONFIG_FILE" 2>/dev/null || echo "")

    if [[ -z "$line" ]]; then
        echo -e "${RED}Error: Connection '$alias' not found${NC}"
        exit 1
    fi

    IFS='|' read -r _ host port user directory command description key <<< "$line"

    # Build SSH command
    local ssh_cmd="ssh"

    if [[ -n "$key" ]]; then
        ssh_cmd="$ssh_cmd -i $key"
    fi

    ssh_cmd="$ssh_cmd -p $port ${user}@${host}"

    # Build remote command
    local remote_cmd=""

    if [[ "$use_tmux" == "true" ]] && [[ -n "$command" ]]; then
        # Tmux split mode: command on top, bash on bottom
        # If session exists, reattach. Otherwise create new.
        local session_name="${alias}"
        local cd_cmd=""
        [[ -n "$directory" ]] && cd_cmd="cd $directory && "

        remote_cmd="if tmux has-session -t ${session_name} 2>/dev/null; then \
tmux attach -t ${session_name}; \
else \
${cd_cmd}tmux new-session -d -s ${session_name} && \
tmux split-window -h -t ${session_name} && \
tmux send-keys -t ${session_name}:0.0 '${command}' C-m && \
tmux select-pane -t ${session_name}:0.0 && \
tmux attach -t ${session_name}; \
fi"
    elif [[ -n "$directory" ]] && [[ -n "$command" ]]; then
        remote_cmd="cd $directory && $command; exec \$SHELL"
    elif [[ -n "$directory" ]]; then
        remote_cmd="cd $directory && exec \$SHELL"
    elif [[ -n "$command" ]]; then
        remote_cmd="$command; exec \$SHELL"
    fi

    echo -e "${GREEN}Connecting to: $alias ($description)${NC}"
    echo -e "${BLUE}Host: ${user}@${host}:${port}${NC}"

    if [[ -n "$directory" ]]; then
        echo -e "${BLUE}Directory: $directory${NC}"
    fi

    if [[ -n "$command" ]]; then
        echo -e "${BLUE}Command: $command${NC}"
    fi

    if [[ "$use_tmux" == "true" ]]; then
        echo -e "${YELLOW}Tmux split mode: command top, bash bottom${NC}"
    fi

    echo ""

    # Execute
    if [[ -n "$remote_cmd" ]]; then
        exec $ssh_cmd -t "$remote_cmd"
    else
        exec $ssh_cmd
    fi
}

# Main
main() {
    init_config

    # Get script name (for smd detection)
    local script_name=$(basename "$0")

    # Handle different invocations
    case "$script_name" in
        smd)
            # smd = connect to default (quick access)
            local default_conn=$(get_default)
            if [[ -n "$default_conn" ]]; then
                # Check for -t flag
                if [[ "${1:-}" == "-t" ]] || [[ "${1:-}" == "--tmux" ]]; then
                    connect "$default_conn" "true"
                else
                    connect "$default_conn"
                fi
            else
                echo -e "${RED}No default connection set. Use 'sm set <alias>' to set one.${NC}"
                exit 1
            fi
            ;;
        sm)
            # sm with arguments
            if [[ $# -eq 0 ]]; then
                # No args = interactive selection
                interactive_select
            elif [[ "$1" == "list" ]]; then
                list_connections
            elif [[ "$1" == "set" ]]; then
                if [[ $# -lt 2 ]]; then
                    echo -e "${RED}Usage: sm set <alias>${NC}"
                    exit 1
                fi
                set_default "$2"
            elif [[ "$1" == "-t" ]] || [[ "$1" == "--tmux" ]]; then
                # sm -t = default connection with tmux
                local default_conn=$(get_default)
                if [[ -n "$default_conn" ]]; then
                    connect "$default_conn" "true"
                else
                    echo -e "${RED}No default connection set${NC}"
                    exit 1
                fi
            else
                # Direct connection by alias, check for -t flag
                if [[ "${2:-}" == "-t" ]] || [[ "${2:-}" == "--tmux" ]]; then
                    connect "$1" "true"
                else
                    connect "$1"
                fi
            fi
            ;;
        *)
            echo -e "${RED}Unknown command: $script_name${NC}"
            exit 1
            ;;
    esac
}

main "$@"
